<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aluminum Alloy Properties Predictor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Aluminum Alloy Properties Predictor</h1>
            <p class="subtitle">Upload your aluminum alloy data to predict mechanical properties</p>
        </header>

        <div class="upload-section">
            <div class="card">
                <h2>Upload Data File</h2>
                <p class="instructions">
                    Upload an Excel (.xlsx, .xls) or CSV file containing aluminum alloy composition and processing data.
                </p>

                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
                    <label for="fileInput" class="file-label">
                        <span class="file-icon">üìÅ</span>
                        <span id="fileName">Choose a file</span>
                    </label>
                </div>

                <button id="predictBtn" class="btn-primary" disabled>Predict Properties</button>

                <div id="loadingSpinner" class="spinner" style="display: none;">
                    <div class="spinner-ring"></div>
                    <p>Processing your data...</p>
                </div>
            </div>

            <div class="card info-card">
                <h3>Required Columns</h3>
                <div class="columns-list">
                    <ul>
                        <li>Processing</li>
                        <li>Ag, Al, B, Be, Bi, Cd, Co, Cr, Cu</li>
                        <li>Er, Eu, Fe, Ga, Li, Mg, Mn, Ni</li>
                        <li>Pb, Sc, Si, Sn, Ti, V, Zn, Zr</li>
                        <li>class</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <div id="resultsSection" class="results-section" style="display: none;">
            <div class="card">
                <h2>Prediction Results</h2>
                <p class="results-info">Found <strong id="numSamples">0</strong> sample(s) in your file</p>

                <div class="table-container">
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th rowspan="2">Sample #</th>
                                <th colspan="2">Elongation (%)</th>
                                <th colspan="2">Tensile Strength (MPa)</th>
                                <th colspan="2">Yield Strength (MPa)</th>
                            </tr>
                            <tr>
                                <th class="model-header">RF</th>
                                <th class="model-header">XGBoost</th>
                                <th class="model-header">RF</th>
                                <th class="model-header">XGBoost</th>
                                <th class="model-header">RF</th>
                                <th class="model-header">XGBoost</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                        </tbody>
                    </table>
                </div>

                <div class="button-group">
                    <button id="downloadBtn" class="btn-secondary">Download Results as CSV</button>
                    <button id="resetBtn" class="btn-secondary">Upload New File</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const predictBtn = document.getElementById('predictBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const errorMessage = document.getElementById('errorMessage');
        const resultsSection = document.getElementById('resultsSection');
        const resultsBody = document.getElementById('resultsBody');
        const numSamples = document.getElementById('numSamples');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');

        let predictionsData = [];

        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                fileName.textContent = this.files[0].name;
                predictBtn.disabled = false;
                errorMessage.style.display = 'none';
            } else {
                fileName.textContent = 'Choose a file';
                predictBtn.disabled = true;
            }
        });

        predictBtn.addEventListener('click', async function() {
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            loadingSpinner.style.display = 'block';
            predictBtn.disabled = true;
            errorMessage.style.display = 'none';
            resultsSection.style.display = 'none';

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    displayResults(data.predictions, data.num_samples);
                } else {
                    showError(data.error || 'An error occurred during prediction');
                }
            } catch (error) {
                showError('Failed to connect to the server. Please try again.');
            } finally {
                loadingSpinner.style.display = 'none';
                predictBtn.disabled = false;
            }
        });

        function displayResults(predictions, count) {
            predictionsData = predictions;
            numSamples.textContent = count;
            resultsBody.innerHTML = '';

            predictions.forEach(pred => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${pred.row}</td>
                    <td>${pred.rf_elongation}</td>
                    <td>${pred.xgb_elongation}</td>
                    <td>${pred.rf_tensile_strength}</td>
                    <td>${pred.xgb_tensile_strength}</td>
                    <td>${pred.rf_yield_strength}</td>
                    <td>${pred.xgb_yield_strength}</td>
                `;
                resultsBody.appendChild(row);
            });

            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            errorMessage.scrollIntoView({ behavior: 'smooth' });
        }

        downloadBtn.addEventListener('click', function() {
            const csv = ['Sample,RF Elongation (%),XGBoost Elongation (%),RF Tensile Strength (MPa),XGBoost Tensile Strength (MPa),RF Yield Strength (MPa),XGBoost Yield Strength (MPa)'];
            predictionsData.forEach(pred => {
                csv.push(`${pred.row},${pred.rf_elongation},${pred.xgb_elongation},${pred.rf_tensile_strength},${pred.xgb_tensile_strength},${pred.rf_yield_strength},${pred.xgb_yield_strength}`);
            });

            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'predictions_results.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        });

        resetBtn.addEventListener('click', function() {
            fileInput.value = '';
            fileName.textContent = 'Choose a file';
            predictBtn.disabled = true;
            resultsSection.style.display = 'none';
            errorMessage.style.display = 'none';
            predictionsData = [];
        });
    </script>
</body>
</html>
